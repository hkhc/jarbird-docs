---
title: Simple Library with Signature
tags: tutorial
sidebar_label: Library with Signature
sidebar_position: 3
---
In this tutorial we are going to build out minimal component with digital
signature.

The sample project is [here](https://github.
com/hkhc/jarbird-samples/simplelib-sign).

## GnuPG

First we need to set up signing key pair. (If you already have it, just 
[skip](#project-setup) this part) It is a one off task, that we may reuse 
the key pair for all of our projects. There are various choices to do so, 
but we do the simplest thing here. Please refer to the "Signing 
configuration" (TODO) for other possibilities.

We need to have an implementation of GnuPG installed on our computer. There are a few choices:

- [GnuPG](https://gnupg.org/) 2.2 or above (Unix/Mac)
- [GPGTools](https://gpgtools.org) (Mac)
- [Gpg4win](https://gpg4win.org) (Windows).

Keypair can be generated by the command `gpg --gen-key`. We need to provide name and email address.

```shell-session {10,11,15}
$ gpg --gen-key
gpg (GnuPG/MacGPG2) 2.2.24; Copyright (C) 2020 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: Jarbird Demo
Email address: jarbird.demo@fake-email.com
You selected this USER-ID:
    "Jarbird Demo <jarbird.demo@fake-email.com>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? O
```

You will be asked for a passphrase to protect the key pair at this point. It 
is passphrase of your keybox file. If you already have it, use the same passphrase. Otherwise, create a new passphrase and keep it safe.

```shell-session {14}
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key BCCF8CD8B61806FE marked as ultimately trusted
gpg: revocation certificate stored as '/Users/me/.gnupg/openpgp-revocs.d/6BA0B340ABB2411040589423BCCF8CD8B61806FE.rev'
public and secret key created and signed.

pub   rsa3072 2021-05-12 [SC] [expires: 2023-05-12]
      6BA0B340ABB2411040589423BCCF8CD8B61806FE
uid                      Jarbird Demo <jarbird.demo@fake-email.com>
sub   rsa3072 2021-05-12 [E] [expires: 2023-05-12]
$
```

The generated key is identified by the key ID (that ended with `B61806FE`)

## <a name="project-setup"></a>Project setup

### gradle.properties

The build script is configured to use the key ID and passphrease by putting them in gradle.properties. It could be the `~/.gradle/gradle.properties` or `gradle.properties` under the project directory.

:::caution
However, putting this information at `~/.gradle/gradle.properties` is
preferable to avoid putting sensitive information in project.

TODO CI/CD
:::

```properties title="~/.gradle/gradle.properties"
# ...
signing.gnupg.keyName=B61806FE
signing.gnupg.passphrase=your-GnuPg-passphrase
# ...
```

The keyName is the last 8 characters of the key ID in the result of key generation. If you forget it, use `gpg --list-key` to find it.

Now we have key pair, then we may update the component version in `pom.yaml`

### pom.yaml

```yaml title="pom.yaml" {3}
group: jarbirdsamples
artifactId: simplelib
version: 1.0
```

The version suffix `-SNAPSHOT` is removed. Then we may publish the component again:

### Run it

```shell-session {4}
$ ./gradlew jbPublish

> Configure project :
WARNING: [io.hkhc.jarbird] Setting to use gpg keyring file but signing gpg keybox  configuration is found. Switch to use gpg keybox

> Task :jbDokkaHtmlSimplelib
Initializing plugins
Dokka is performing: documentation for simplelib
Validity check
Creating documentation models

WARN: The registry key 'java.correct.class.type.by.place.resolve.scope' accessed, but not loaded yet

> Task :jbDokkaHtmlSimplelib
Transforming documentation model before merging
Merging documentation models
Transforming documentation model after merging
Creating pages
Transforming pages
Rendering


BUILD SUCCESSFUL in 8s
9 actionable tasks: 9 executed
```

Then we complete component publishing.

### Get rid of GnuPG warning

We have a warning indicates that Jarbird expects to find the old style keyring 
file, but not found. So it tries to find the signing key pair in newer keybox file. 
To get rid of the warning, we may tell Jarbird explicitly that we want to use 
keybox file. This can be done by updating the `build.gradle` file.

<!--tabs-->
# Groovy
```groovy title="build.gradle" {5}
// ...
jarbird {
    pub {
        mavenLocal()
        useGpg = true
    }
}
// ...
```
# Kotlin
```kotlin title="build.gradle.kts" {5}
// ...
jarbird {
    pub {
        mavenLocal()
        useGpg = true
    }
}
// ...
```
<!--/tabs-->

Then we have clean result without such warning.

Nevertheless, the produced results are the same, in `~/.me/repository/jarbirdsamples/simplelib/1.0`

```shell-session
$ ls -1 ~/.m2/repository/jarbirdsamples/simplelib/1.0
simplelib-1.0-javadoc.jar
simplelib-1.0-javadoc.jar.asc
simplelib-1.0-sources.jar
simplelib-1.0-sources.jar.asc
simplelib-1.0.jar
simplelib-1.0.jar.asc
simplelib-1.0.module
simplelib-1.0.module.asc
simplelib-1.0.pom
simplelib-1.0.pom.asc
```

The files with `.asc` extension are the signature file.
Note that the `metadata-local.xml` file when building `1.0-SNAPSHOT` is not
here. The non `SNAPSHOT` version does not need the file.

## In case I forget to configure signing key

The sample project `simplelib-sign` illustrates the publishing of signed component. 
Add your signing key configuration in gradle.properties before run. If there is no 
key configuration provided, and the publication is not SNAPSHOT version, then 
the following warning is shown when doing `./gradlew jbPublish`

```shell-session
WARNING: [io.hkhc.jarbird] No signing setting is provided. Signing operation is ignored. Maven Central publishing cannot be done without signing the artifacts.
WARNING: [io.hkhc.jarbird] Signing configuration for keybox file is not complete. Signing operation is ignored. Maven Central publishing cannot be done without signing the artifacts.
```
